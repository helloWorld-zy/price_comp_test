# Feature Specification: 邮轮航次各房型价格统计对比工具

**Feature Branch**: `001-cruise-price-compare`  
**Created**: 2026-01-22  
**Status**: Draft  
**Input**: User description: "邮轮航次各房型价格统计对比工具"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 供应商文件上传与 LLM 识别 (Priority: P1)

供应商用户上传 PDF 或 Word 文件，系统自动抽取文本内容，通过 LLM 识别航次、房型、价格等信息，用户确认后入库，生成历史价格记录。

**Why this priority**: 这是系统核心价值所在——自动化识别替代人工录入，大幅提升效率。供应商最常用的场景是批量导入报价文件。

**Independent Test**: 可通过上传一个包含航次报价的 PDF 文件，验证系统能正确识别并入库，查看历史记录可见新增条目。

**Acceptance Scenarios**:

1. **Given** 已登录的供应商用户，**When** 上传一份包含航次报价的 PDF 文件，**Then** 系统抽取文本并展示 LLM 识别结果（航次、房型、价格、币种、口径）
2. **Given** LLM 识别结果展示中，**When** 用户确认无误并提交，**Then** 报价入库，历史记录新增一条
3. **Given** LLM 识别结果展示中，**When** 用户发现识别错误并修正后提交，**Then** 按修正后的内容入库
4. **Given** 上传的 PDF 中某些页面无法解析，**When** 系统处理完成，**Then** 明确标识失败页码并提供人工确认入口

---

### User Story 2 - 供应商手动录入报价 (Priority: P2)

供应商用户在指定航次下选择房型，手动输入价格与备注，立即入库并保留历史。

**Why this priority**: 作为文件导入的补充，支持快速录入单条报价，适用于小批量更新或临时调整场景。

**Independent Test**: 可通过选择一个航次和房型，输入价格后提交，验证历史记录中新增一条。

**Acceptance Scenarios**:

1. **Given** 已登录的供应商用户，**When** 选择航次和房型，输入价格、币种、备注后提交，**Then** 报价立即入库
2. **Given** 同一航次+房型+供应商已有历史报价，**When** 提交新报价，**Then** 新增一条记录而非覆盖旧记录
3. **Given** 手动录入界面，**When** 必填字段缺失，**Then** 显示明确的字段级错误提示

---

### User Story 3 - 管理员模板批量导入 (Priority: P2)

管理员通过 Excel 模板批量导入航次与房型基础数据，供应商随后可对这些航次进行报价。

**Why this priority**: 为供应商报价提供基础数据支撑，是系统正常运转的前置条件。

**Independent Test**: 可通过下载模板、填充数据、上传后验证航次和房型数据已入库。

**Acceptance Scenarios**:

1. **Given** 管理员用户，**When** 下载航次/房型 Excel 模板，**Then** 获得格式正确的模板文件
2. **Given** 管理员用户，**When** 上传填充好的模板文件，**Then** 系统解析并批量创建航次和房型
3. **Given** 模板中存在格式错误或重复数据，**When** 上传处理，**Then** 返回详细的行级错误信息

---

### User Story 4 - 管理员 LLM 生成基础数据 (Priority: P3)

管理员粘贴市场推广文字，LLM 识别并提出候选邮轮/航次/房型结构，管理员逐条确认、去重合并后入库。

**Why this priority**: 提升管理员维护基础数据的效率，但不如模板导入和报价采集紧迫。

**Independent Test**: 可通过粘贴一段航次推广文字，验证系统展示候选结构，确认后入库。

**Acceptance Scenarios**:

1. **Given** 管理员用户，**When** 粘贴一段航次推广文字，**Then** LLM 识别并展示候选邮轮/航次/房型结构
2. **Given** 候选结构展示中，**When** 管理员确认单条，**Then** 该条入库
3. **Given** 候选结构中存在重复项，**When** 管理员合并去重后确认，**Then** 按合并结果入库

---

### User Story 5 - 价格对比表与趋势图 (Priority: P1)

用户在前端查看同航次下多供应商、多房型的价格对比表，点击房型进入历史趋势图，支持筛选和导出。

**Why this priority**: 这是系统的核心输出价值——让用户能直观对比价格、发现趋势，是最终业务目标。

**Independent Test**: 可通过打开对比页面，选择航次后查看价格表，点击房型查看趋势图，导出 Excel。

**Acceptance Scenarios**:

1. **Given** 已有多个供应商对同一航次的报价，**When** 用户打开对比表，**Then** 展示各房型在各供应商下的最新价、更新时间、价差
2. **Given** 对比表中，**When** 用户点击某房型，**Then** 展示该房型的历史价格趋势图（可切换时间范围）
3. **Given** 趋势图中，**When** 用户选择多个供应商叠加对比，**Then** 图表展示多条曲线
4. **Given** 对比结果，**When** 用户点击导出，**Then** 下载 Excel/CSV 格式的对比数据

---

### User Story 6 - 管理员基础数据维护 (Priority: P3)

管理员维护邮轮公司、邮轮、航次、房型、供应商等基础数据，支持增删改查。

**Why this priority**: 系统正常运转的基础，但操作频率相对较低。

**Independent Test**: 可通过创建一个新邮轮公司和邮轮，验证列表中可见新增数据。

**Acceptance Scenarios**:

1. **Given** 管理员用户，**When** 创建/编辑/删除邮轮公司，**Then** 操作成功并更新列表
2. **Given** 管理员用户，**When** 配置某邮轮的房型大类和小类，**Then** 房型树按配置生效
3. **Given** 管理员用户，**When** 创建供应商并设置可见策略，**Then** 供应商生效且权限正确

---

### Edge Cases

- 当 PDF 为扫描件（图片而非文本）时，系统检测并提示用户需要人工录入
- 当 LLM 识别置信度低于阈值时，系统标记警告并要求用户确认
- 当上传的航次/房型在系统中不存在时，支持创建申请或临时映射
- 当同一文件重复上传时，系统通过文件哈希检测并提示用户
- 当价格数据存在异常（如负数或超大值）时，系统拒绝入库并提示原因

## Requirements *(mandatory)*

### Functional Requirements

**基础数据管理（管理员）**

- **FR-001**: 系统 MUST 支持邮轮公司的增删改查（含别名/英文名）
- **FR-002**: 系统 MUST 支持邮轮的增删改查（隶属公司，含别名）
- **FR-003**: 系统 MUST 支持航次的增删改查（邮轮、起止日期、航线/港口、航次编号、备注）
- **FR-004**: 系统 MUST 支持房型大类枚举配置（默认：内舱/海景/阳台/套房）
- **FR-005**: 系统 MUST 支持房型小类按邮轮维护，含排序和启用状态
- **FR-006**: 系统 MUST 支持供应商的增删改查（名称、别名、状态、可见策略）
- **FR-007**: 系统 MUST 支持航次/房型和报价的模板导入导出

**报价采集（供应商用户）**

- **FR-008**: 系统 MUST 支持上传 PDF/Word 文件进行报价导入
- **FR-009**: 系统 MUST 支持粘贴文本进行报价导入
- **FR-010**: 系统 MUST 支持单航次-房型的手动报价录入
- **FR-011**: 系统 MUST 支持 Excel 模板批量导入报价
- **FR-012**: 系统 MUST 展示 LLM 识别结果，包含航次/房型/价格/币种/口径/适用条件
- **FR-013**: 系统 MUST 支持用户对识别结果进行纠错和修正
- **FR-014**: 当航次/房型不存在时，系统 MUST 支持创建申请或临时映射
- **FR-015**: 同一航次+房型+供应商的每次报价 MUST 新增记录而非覆盖
- **FR-016**: 系统 MUST 支持报价的作废/更正，不物理删除，标记状态

**对比与趋势**

- **FR-017**: 系统 MUST 提供按航次维度的多供应商多房型价格对比表
- **FR-018**: 对比表 MUST 展示最新价、更新时间、与上次价差
- **FR-019**: 系统 MUST 提供房型维度的价格历史趋势图
- **FR-020**: 趋势图 MUST 支持叠加多供应商对比
- **FR-021**: 系统 MUST 支持对比结果导出（Excel/CSV）

**文件处理与 LLM**

- **FR-022**: PDF 文本抽取 MUST 可追溯（页码、段落、失败页）
- **FR-023**: LLM 识别输出 MUST 包含：航次定位、房型、价格、置信度、警告
- **FR-024**: 解析策略 MUST 先匹配基础数据（字符串相似度/别名），再 LLM 结构化提取

**权限与审计**

- **FR-025**: 管理员 MUST 能查看全量数据与审计日志
- **FR-026**: 供应商用户 MUST 只能查看本供应商的历史报价
- **FR-027**: 系统 MUST 记录每次导入/识别任务的详细信息（耗时、模型、提示词版本、结果摘要）

**API 要求**

- **FR-028**: 所有接口返回 MUST 包含错误码、可读错误信息、字段级错误
- **FR-029**: 列表接口 MUST 支持分页、排序、过滤（航次日期范围、邮轮公司、供应商、房型大类等）

### Key Entities

- **CruiseLine（邮轮公司）**: 航运公司实体，包含名称、别名、英文名，拥有多艘邮轮
- **Ship（邮轮）**: 具体船只，隶属于邮轮公司，拥有自己的房型配置
- **Sailing（航次）**: 具体航程，包含邮轮、起止日期、航线/港口、航次编号等
- **CabinCategory（房型大类）**: 房型分类枚举（如内舱、海景、阳台、套房），可自定义
- **CabinType（房型小类）**: 具体房型，隶属于 Ship + Category，包含排序和启用状态
- **Supplier（供应商）**: 报价提供方，包含名称、别名、状态、可见策略
- **PriceQuote（报价记录）**: 核心业务实体，关联 Sailing + CabinType + Supplier，包含金额、币种、口径、备注、来源、原始文本引用、状态、时间戳
- **ImportJob（导入任务）**: 记录文件/文本导入的任务信息，包含模型版本、结果摘要、错误

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 供应商用户能在 5 分钟内完成一份标准 PDF 报价文件的上传、确认和入库流程
- **SC-002**: LLM 识别准确率达到 85% 以上（以人工确认无需修改为准）
- **SC-003**: 系统支持 50 个并发用户同时进行报价录入和查询，响应时间不超过 3 秒
- **SC-004**: 价格对比表加载时间不超过 2 秒（1000 条报价记录规模）
- **SC-005**: 历史趋势图能展示过去 12 个月的价格变化，切换时间范围响应时间不超过 1 秒
- **SC-006**: 管理员能在 10 分钟内通过模板完成 100 条航次数据的批量导入
- **SC-007**: 所有报价历史完整保留，任意时间点的价格可追溯
- **SC-008**: 审计日志能准确记录所有数据变更，包含操作者、时间、变更内容
- **SC-009**: 文件导入失败率低于 5%（格式正确的文件）
- **SC-010**: 用户首次使用无需培训即可完成基本报价录入（任务完成率 > 80%）

## Assumptions

- 供应商用户已由管理员预先创建并绑定供应商身份
- LLM 服务（Ollama）已在本地部署并可用
- PDF 文件主要为文本型 PDF（非扫描件），扫描件需降级处理
- 初始房型大类为：内舱、海景、阳台、套房，可由管理员扩展
- 价格币种默认支持人民币（CNY），可扩展其他币种
- 系统部署在内网环境，无需考虑公网安全策略
